@using Microsoft.AspNet.Identity
@model Tuple<QuickEmisorModel, bool>
@{
    UsuarioModel ObjUsuario = ViewBag.vObjUsuario;

    List<SelectListItem> listItems = ImpuestoAdicionalRetencionesModel.GetDropDownListHTML();
    List<SelectListItem> lstValidDocs = (List<SelectListItem>)ViewBag.lstValidDocs;
    List<QuickReceptorModel> lstReceptoresUsuarios = (List<QuickReceptorModel>)ViewBag.ConjuntoReceptores;

    //List<string> lstAdvertencias = ParseExtensions.Revisar_Advertir_CAF(User.Identity.GetUserId(), Session);
}


@using (Html.BeginForm("MakeFacturaRecurrente_Make", "Home", FormMethod.Post, new { id = "MakeFacturaNeo" }))
{
    <input value="1" name="MakeNew" id="MakeNew" type="hidden">
    <input value="0" name="IsExentaIVA" id="IsExentaIVA" type="hidden">
    if (Model.Item2 == false)
    {
        <input value="0" name="opt" id="opt" type="hidden" />
    }

    <!-- Page-Title -->
    <div class="row">
        <div class="col-sm-12">
            <div class="page-header-2">
                <h2 class="page-header">Factura Recurrente</h2>
                <ol class="breadcrumb">
                    <li>
                        <a href="#">Ventas</a>
                    </li>
                    <li class="active">
                        <a href="#">Facturas Recurrentes</a>
                    </li>
                </ol>
            </div>
        </div>
    </div>

    <div class="panel panel-2">
        <div class="panel-heading">
            <h3>Datos Factura Recurrente</h3>
        </div>

        <div class="panel-body" id="DatosReceptor">
            <div class="row form-group">
                <div class="col-lg-3 m-t-15">
                    <label class="control-label text-center">Fecha de Inicio<span data-toggle="tooltip" title="Fecha en la que se crea la primer factura de venta" class="ion-help-circled" style="cursor:help;width:21px;"></span> </label>
                    <input value="@ParseExtensions.ToDD_MM_AAAA(DateTime.Now)" id="FechaRecurrenteInicio" name="FechaRecurrenteInicio" class="form-control" type="text" placeholder="Fecha Inicio">
                </div>
                <div class="col-lg-3 m-t-15">
                    <label class="control-label text-center">Fecha de Finalización<span data-toggle="tooltip" title="Indica el último día de la creación automática de la factura de venta." class="ion-help-circled" style="cursor:help;width:21px;"></span></label>
                    <input id="FechaRecurrenteFinal" name="FechaRecurrenteFinal" class="form-control" type="text" placeholder="Fecha Fin">
                </div>
                <div class="col-lg-3 m-t-15">
                    <label class="control-label text-center">Frecuencia<span data-toggle="tooltip" title="Indica cada cuántos meses se generará la factura de venta, por ejemplo si eliges 2 se creará cada 2 meses." class="ion-help-circled" style="cursor:help;width:21px;"></span></label>
                    <input id="Frecuencia" name="Frecuencia" class="form-control" value="1" type="number" min="1" step="1" placeholder="Frecuencia Mensual">
                </div>

                <div class="col-lg-3 m-t-15">
                    <label class="control-label text-center">Vencimiento de Pago:</label>
                    <select class="form-control custom-select" id="fechavenc" name="fechavenc" value="0">
                        <option value="0">Seleccione Vencimiento Pago</option>
                        <option value="1">Pago inmediato</option>
                        <option value="30">30 días</option>
                        <option value="60">60 días</option>
                        <option value="90">90 días</option>
                        <option value="120">120 días</option>
                        <option value="150">150 días</option>
                        <option value="180">180 días</option>
                        <option value="180">180 días</option>
                        <option value="210">210 días</option>
                        <option value="240">240 días</option>
                        <option value="270">270 días</option>
                        <option value="300">300 días</option>
                        <option value="330">330 días</option>
                        <option value="360">360 días</option>
                    </select>
                </div>
            </div>

            <div class="row">
                <div class="col-lg-6">
                    <select name="tipodoc" id="tipodoc" class="form-control">
                        <option disabled selected value>Seleccione tipo de Documento</option>
                        @foreach (SelectListItem tipoDocConCafCargados in lstValidDocs)
                        {
                            <option value="@tipoDocConCafCargados.Value">@tipoDocConCafCargados.Text</option>
                        }
                    </select>
                </div>
                <div class="col-lg-5" id="zonaSelectReceptor">
                    <select id="id_receptor" name="id_receptor" class="selectpicker show-tick form-control">
                        <option disabled selected value>Seleccione Receptor</option>
                        @foreach (QuickReceptorModel ReceptorUsuario in lstReceptoresUsuarios)
                        {
                            <option value="@ReceptorUsuario.QuickReceptorModelID">@(ReceptorUsuario.RazonSocial + " - " + ReceptorUsuario.RUT)</option>
                        }
                    </select>
                </div>
                <div class="col-lg-1">
                    <a onclick="callEditReceptor();" class="btn btn-icon waves-effect waves-light btn-primary pull-left" data-toggle="tooltip" title="Editar Cliente!"><i class="ion-edit"></i></a>
                </div>
            </div>
        </div>
    </div>


    <div id="DetalleDiv">
        <div class="panel panel-3">
            <div class="panel-heading">
                <div class="col-md-10">
                    <h3>Detalle Producto o Servicio</h3>
                </div>

                <div class="col-md-1">
                    <a onclick="removeLastRow();" name="REMOVE_DETALLE" value="Remover ITEM" class="btn btn-icon waves-effect waves-light btn-danger pull-right"><i class="ion-android-close"></i></a>
                    @*<input class="btn-2outline btn pull-right" onclick="removeLastRow();" name="REMOVE_DETALLE" value="Remover ITEM" type="button">*@
                </div>
                <div class="col-md-1">
                    <a onclick="addMoreRows(this.form);" name="AGREGA_DETALLE" value="Agrega ITEM" class="btn btn-icon waves-effect waves-light btn-success pull-right"><i class="ion-android-add"></i></a>
                    @*<input class="btn btn-2 pull-right" onclick="addMoreRows(this.form);" name="AGREGA_DETALLE" value="Agrega ITEM" type="button">*@
                </div>
            </div>
            <div class="panel-body">
                <div id="Detalle">
                    <div class="row m-t-30">
                        <div class="col-md-3">
                            <label class="control-label text-center">Descripción</label>
                            <input class="form-control" placeholder="Nombre del producto" name="EFXP_NMB_1" id="EFXP_NMB_1" type="text" maxlength="75">
                        </div>
                        <div class="col-md-1">
                            <label class="control-label text-center">Cantidad</label>
                            <input class="form-control" placeholder="Cantidad" name="EFXP_QTY_1" id="EFXP_QTY_1" type="number" min="0" lang="en-150">
                        </div>
                        <div class="col-md-1">
                            <label class="control-label text-center">Medida</label>
                            <input class="form-control" placeholder="Unidad de Medida" name="UnmdItem_1" id="UnmdItem_1" type="text" maxlength="4">
                        </div>
                        <div class="col-md-2">
                            <label class="control-label text-center">Precio</label>
                            <input class="form-control" placeholder="Precio" name="EFXP_PRC_1" id="EFXP_PRC_1" type="number" min="0" step="1" lang="en-150">
                        </div>
                        <div class="col-md-2">
                            <label class="control-label">Impuesto Adicional</label>
                            <select name="IMPUESTO_ADICIONAL_1" id="IMPUESTO_ADICIONAL_1" class="form-control">
                                <option value="[0,0]">Ninguno</option>
                                <option value="[23,15]">Art. de Oro, Joyas y Pieles Finas (15%)</option>
                                <option value="[44,15]">Tapices, Casas Rodantes, Caviar y Armas de Aire (15%)</option>
                                <option value="[24,31.5]">Licores, Pisco, Destilados (31.5%)</option>
                                <option value="[25,20.5]">Vinos, Chichas, Sidras (20.5%)</option>
                                <option value="[26,20.5]">Cervezas y Otras Bebidas Alcoholicas (20.5%)</option>
                                <option value="[27,10]">Aguas Minerales y Bebidas Analcoholicas (10%)</option>
                                <option value="[271,18]">Bebidas Analcoholicas con alto contenido de Azucar (18%)</option>
                                <option value="[15,19]">IVA Retenido Total</option>
                            </select>
                        </div>
                        <div class="col-md-1">
                            <label class="control-label text-center">Desc. (%)</label>
                            <input class="form-control" name="Descuento_1" id="Descuento_1" min="0" type="number">
                        </div>
                        <div class="col-md-2">
                            <label class="control-label text-center">Subtotal</label>
                            <input class="form-control" readonly name="EFXP_SUBT_1" id="EFXP_SUBT_1" type="number">
                        </div>
                    </div>

                </div>

                <div id="ReferenciaYPago" class="m-t-30">
                    <div class="row">
                        @if (ParseExtensions.ItsUserOnCertificationEnvironment(User.Identity.GetUserId()) == true)
                        {
                            <div class="col-md-3">
                                Referencias : Si/No
                                <input id="REF_SI_NO" name="REF_SI_NO" value="SiChecked" type="checkbox">
                            </div>
                        }
                    </div>
                </div>

                <div id="Referencias" style="display: none;">
                    <hr>
                    <div id="ReferenciasDetail">
                        <div class="row form-group">
                            <div class="col-md-3">
                                @*
                                    <label class="control-label">Operación</label>
                                    <select class="form-control" name="CodOperacion1" id="CodOperacion1" value="">
                                        <option value="">Seleccionar</option>
                                        <option value="1">Anula documento de referencia</option>
                                        <option value="2">Corrige texto de documento de referencia</option>
                                        <option value="3">Corrige montos</option>
                                    </select>*@
                            </div>
                            <div class="col-md-5"><label class="control-label">Motivo</label> <input class="form-control" placeholder="Escriba el motivo" name="motivo1" id="motivo1" type="text" maxlength="90"> </div>
                            <div class="col-md-3">
                                <label class="control-label">Tipo Documento</label>
                                <select class="form-control" name="TipoDocRef1" id="TipoDocRef1" value="">
                                    <option value="">Seleccionar</option>
                                    <option value="30">Factura</option>
                                    @*<option value="32">Factura de venta bienes y servicios no afectos o exentos de IVA</option>*@
                                    @*<option value="35">Boleta</option>*@
                                    @*<option value="38">Boleta exenta</option>*@
                                    <option value="45">Factura de compra</option>
                                    <option value="55">Nota de débito</option>
                                    <option value="60">Nota de crédito</option>
                                    @*<option value="40">Liquidación Factura</option>*@
                                    @*<option value="43">Liquidación-Factura Electrónica</option>*@
                                    <option value="33">Factura Electrónica</option>
                                    <option value="34">Factura No Afecta o Exenta Electrónica</option>
                                    @*<option value="39">Boleta Electrónica</option>*@
                                    @*<option value="41">Boleta Exenta Electrónica</option>*@
                                    <option value="46">Factura de Compra Electrónica.</option>
                                    <option value="56">Nota de Débito Electrónica</option>
                                    <option value="61">Nota de Crédito Electrónica</option>
                                    <option value="50">Guía de Despacho.</option>
                                    <option value="52">Guía de Despacho Electrónica</option>
                                    @*<option value="103">Liquidación</option>*@
                                    @*<option value="110">Factura de Exportación Electrónica</option>*@
                                    @*<option value="111">Nota de Débito de Exportación Electrónica</option>*@
                                    @*<option value="112">Nota de Crédito de Exportación Electrónica</option>*@
                                    <option value="801">Orden de Compra</option>
                                    @*<option value="802">Nota de pedido</option>*@
                                    @*<option value="803">Contrato</option>*@
                                    @*<option value="804">Resolución</option>*@
                                    @*<option value="805">Proceso ChileCompra</option>*@
                                    @*<option value="806">Ficha ChileCompra</option>*@
                                    @*<option value="807">DUS</option>*@
                                    @*<option value="808">B/L (Conocimiento de embarque)</option>*@
                                    @*<option value="809">AWB (Air Will Bill)</option>*@
                                    @*<option value="810">MIC/DTA</option>*@
                                    @*<option value="811">Carta de Porte</option>*@
                                    @*<option value="812">Resolución del SNA donde califica Servicios de Exportación</option>*@
                                    @*<option value="813">Pasaporte</option>*@
                                    @*<option value="814">Certificado de Depósito Bolsa Prod. Chile.</option>*@
                                    @*<option value="815">Vale de Prenda Bolsa Prod. Chile</option>*@
                                    <option value="-4444">SET</option>
                                </select>
                            </div>
                            <div class="col-md-1"><label class="control-label">Folio</label> <input class="form-control" placeholder="" name="ref_folio1" id="ref_folio1" type="text"> </div>
                        </div>
                    </div>
                    <div class="col-md-2 col-md-offset-1">
                        <input class="btn-2outline btn" onclick="removeLastRef();" name="REMOVE_REF" value="-" type="button">
                    </div>
                    <div class="col-md-3 col-md-offset-1">
                        <input class="btn btn-2" onclick="addMoreRef(this.form);" name="AGREGA_REF" value="+" type="button">
                    </div>
                </div>


            </div>
        </div>
    </div>

    <div class="panel panel-4">
        <div class="panel-heading">
            <div class="col-md-12">
                <h3>Totales</h3>
            </div>
        </div>
        <div class="panel-body">
            <div id="Totales">
                <div class="row">
                    <div class="col-md-6"></div>
                    <div class="col-md-4"><label class="control-label">Sub Total</label></div>
                    <div class="col-md-2"><input disabled="disabled" class="form-control" maxlength="12" size="10" value="0" name="EFXP_SUBTOTAL" id="EFXP_SUBTOTAL" input="" type="text"></div>
                </div>
                <div class="row m-t-10">
                    <div class="col-md-6"></div>
                    <div class="col-md-2"><label class="control-label">Desc. Global (%)</label></div>
                    <div class="col-md-1"><input class="form-control" maxlength="10" size="10" value="0" min="0" max="100" name="EFXP_PCT_DESC" id="EFXP_PCT_DESC" input="" type="text"></div>
                    <div class="col-md-1"><label class="control-label">Monto</label></div>
                    <div class="col-md-2"><input disabled="disabled" class="form-control" maxlength="12" size="10" value="0" name="EFXP_MNT_DESC" id="EFXP_MNT_DESC" type="text"></div>
                </div>
                <div class="row m-t-10">
                    <div class="col-md-6"></div>
                    <div class="col-md-4"><label class="control-label" id="TitleNETO">Monto Neto</label></div>
                    <div class="col-md-2"><input disabled="disabled" class="form-control" value="0" name="EFXP_MNT_NETO" id="EFXP_MNT_NETO" size="10" maxlength="10" type="text"></div>
                </div>
                <div class="row m-t-10">
                    <div class="col-md-6"></div>
                    <div class="col-md-4"><label class="control-label">IVA (19%)</label></div>
                    <div class="col-md-2"><input disabled="disabled" class="form-control" maxlength="12" size="10" value="0" name="EFXP_IVA" id="EFXP_IVA" type="text"></div>
                </div>
                <input value="" name="MNT_NETO_TEMP" type="hidden">
            </div>
            <div class="row m-t-10">
                <div class="col-md-6"></div>
                <div class="col-md-4"><label class="control-label">Impuesto Adicional</label></div>
                <div class="col-md-2"><input disabled="disabled" class="form-control" value="0" name="Impuesto_total" id="Impuesto_total" size="10" maxlength="10" type="text"></div>
            </div>
            <div class="row m-t-10">
                <div class="col-md-6"></div>
                <div class="col-md-4"><label class="control-label">Total</label></div>
                <div class="col-md-2"><input disabled="disabled" class="form-control" value="0" name="EFXP_MNT_TOTAL" id="EFXP_MNT_TOTAL" size="10" maxlength="10" type="text"></div>
            </div>
        </div>
    </div>


    if (ObjUsuario.DEMO_BLOCK == false)
    {
        <div id="myModal" class="modal fade" role="dialog">
            <div class="modal-dialog modal-sm">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                        <h4 class="modal-title">Confirmar</h4>
                    </div>
                    <div id="ModyBody" class="modal-body text-center form-group">
                        ¿Esta seguro de querer emitir este documento?
                        <br>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-primary  waves-effect waves-light" id="Button_Update" value="Button_Update" name="Button_Update" type="submit">Si</button>
                        <button class="btn btn-primary  waves-effect waves-light" type="button" data-dismiss="modal">No</button>
                    </div>
                </div>
            </div>
        </div>


        <div style="text-align: center;">
            <a id="botonEmitirDocumentoModal" name="modal" class="btn btn-success  waves-effect waves-light" data-toggle="modal" data-target="#myModal">
                <span class="btn-label"><i class="ion-android-add"></i></span>Emitir Documento
            </a>
        </div>
    }

}


<!-- Modal Editar Cliente -->
<div id="ModalEditReceptor" class="modal fade in" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">

    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                <h4 class="modal-title">Editar Datos Cliente</h4>
            </div>
            <div id="ReceptorSeleccionado" class="modal-body">

            </div>
        </div>
    </div>
</div>

<!-- Modal Descuento Recargo -->
<div id="ModalEditDescuentoRecargo" class="modal fade in" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                <h4 class="modal-title">Agregar Descuento/Recargo</h4>
            </div>
            <div id="DescuentoRecargoBody" class="modal-body">

            </div>
        </div>
    </div>
</div>



<script type="text/javascript">
    var refCount = 1;

    $.validator.addMethod("rut", function (value, element) {
        return this.optional(element) || $.Rut.validar(value);
    }, "Este campo debe ser un rut valido.");



    $(document).ready(function () {
        //cantidad * precio
        $('#EFXP_QTY_1').change(function (e) { calculate(rowCount); });
        $('#EFXP_PRC_1').change(function (e) { calculate(rowCount); });
        $('#ValorDR_1').change(function (e) { calculate(rowCount); });
        $('#EFXP_PCT_DESC').change(function (e) { calculate(rowCount); });
        $('#IMPUESTO_ADICIONAL_1').change(function (e) { calculate(rowCount); });
        $('#EFXP_EXENTO_1').change(function (e) { calculate(rowCount) });
        $('#TpoValor_1').on('change', function () { calculate(rowCount) });
        $('#TpoMov_1').on('change', function () { calculate(rowCount) });
        $('#Descuento_1').change(function (e) { calculate(rowCount) });
        $('#EFXP_PCT_DESC').change(function (e) { calculate(rowCount) });

    });

    function callEditReceptor() {
        var IDReceptor = $('#id_receptor').val();
        $.ajax
            ({
                url: "EditarReceptorModal?IDReceptor=" + IDReceptor,
                success: function (html) {
                    $("#ReceptorSeleccionado").html(html);
                    $("#ModalEditReceptor").modal();
                }
            });

    }

    function calculate(ir) {

        var cumulativoImpuesto = 0;

        var subTotalNoExentos = 0;
        var subTotalExentos = 0;

        for (i = 1; i < ir + 1; i++) {
            var step1 = $('#EFXP_QTY_' + i).val() * $('#EFXP_PRC_' + i).val();
            var step5 = 0;

            var step2 = $('#Descuento_' + i).val() / 100;
            step5 = step1 * step2;
            /*
            var SELECTEDVALUE = $('#TpoValor_' + i).val();
            if (SELECTEDVALUE == "%") {
                var step2 = $('#ValorDR_' + i).val() / 100;
                var step5 = step1 * step2;
            }
            if (SELECTEDVALUE == "$") {
                var step2 = $('#ValorDR_' + i).val();
                var step5 = step2;
            }
            if (SELECTEDVALUE == "") {
                $('#ValorDR_' + i).val(0);
                var step5 = 0;
            }*/

            var step3 = JSON.parse($('#IMPUESTO_ADICIONAL_' + i).val())[1] / 100;


            var SELECTEDVALUE = $('#TpoMov_' + i).val();
            /*
            if (SELECTEDVALUE == "R") {
                $('#EFXP_SUBT_' + i).val(+step1 + +step5);
            }
            if (SELECTEDVALUE == "D") {
                $('#EFXP_SUBT_' + i).val(step1 - step5);
            }*/
            $('#EFXP_SUBT_' + i).val(Math.round(step1 - step5));

            //if (SELECTEDVALUE == "") {
            //$('#EFXP_SUBT_' + i).val(step1);
            //}
            $('#EFXP_SUBTOTAL').val(CalcularTotal());

            if ($('#EFXP_EXENTO_' + i).is(':checked')) {
                //Monto Exentos
                subTotalExentos += (step1 - step5);
            }
            else {
                subTotalNoExentos += (step1 - step5);
            }

            $('#EFXP_MNT_EXENTO').val(subTotalExentos.toFixed());

            //descuento global
            var Gdesc = $('#EFXP_PCT_DESC').val() / 100;
            var GvalorDescuento = $('#EFXP_SUBTOTAL').val() * Gdesc;
            Exento = 0

            var Gexento = Exento * Gdesc;
            var GdescArreglado = GvalorDescuento - Gexento;
            valorDescuento = GdescArreglado.toFixed();
            $('#EFXP_MNT_DESC').val(valorDescuento);
            var GmontoNeto = $('#EFXP_SUBTOTAL').val() - GdescArreglado;
            $('#EFXP_MNT_NETO').val(Math.round(GmontoNeto));

            var GTotalIVA = 0;
            //IVA
            if ($("#IsExentaIVA").val() == 0)
            {
                //enable casillas impuesto adicional
                $('#IMPUESTO_ADICIONAL_' + i).removeAttr('disabled');
                //$('#IMPUESTO_ADICIONAL_' + i).attr("readonly", false);

                var GValorIVA = 0.19;
                GTotalIVA = GValorIVA * ($('#EFXP_MNT_NETO').val());//GmontoNeto;  EFXP_MNT_NETO
                if (GTotalIVA < 0)
                    GTotalIVA = 0;
                var ivatotal = GTotalIVA.toFixed();
                $('#EFXP_IVA').val(ivatotal);
            }
            else
            {
                //disable casillas impuesto adicional and set them to 0
                $('#IMPUESTO_ADICIONAL_' + i).val("[0,0]");
                $('#IMPUESTO_ADICIONAL_' + i).attr('disabled', 'disabled');
                //$('#IMPUESTO_ADICIONAL_' + i).attr("readonly", true);

                GTotalIVA = 0;
                $('#EFXP_IVA').val(GTotalIVA);
            }
            GmontoTotal = GmontoNeto + GTotalIVA /* - GvalorDescuento*/;

            //Impuesto Total
            var ValorImpuestoAdicionalLinea = $('#EFXP_SUBT_' + i).val() * step3;
            ValorImpuestoAdicionalLinea = ValorImpuestoAdicionalLinea - (ValorImpuestoAdicionalLinea * Gdesc);
            cumulativoImpuesto = cumulativoImpuesto + Math.round(ValorImpuestoAdicionalLinea);

            $('#Impuesto_total').val(cumulativoImpuesto);
            GmontoTotal = GmontoTotal + cumulativoImpuesto;
            var montoTotal = GmontoTotal.toFixed();
            $('#EFXP_MNT_TOTAL').val(montoTotal);
        }

    }



    /*montos totales*/
    function CalcularTotal() {
        var result = 0;
        $('[name*="EFXP_SUBT_"]').each(function () {
            result += parseFloat($(this).val(), 10);
        });
        return result;
    }



    $(document).ready(function () {



        $("#MakeFacturaNeo").validate({
            ignore: [],
            rules: {
                tipodoc: "required",
                id_receptor: "required",
                EFXP_RZN_SOC_RECEP: "required",
                EFXP_DIR_RECEP: "required",
                EFXP_CMNA_RECEP: "required",
                EFXP_CIUDAD_RECEP: "required",
                EFXP_GIRO_RECEP: "required",
                EFXP_NMB_1: "required",
                EFXP_QTY_1: { required: true, number: true },
                EFXP_PRC_1: { required: true, number: true },
            },
            messages: {
                tipodoc: "Debe seleccionar un tipo de DTE",
                id_receptor: "Debe seleccionar un receptor",
                EFXP_RZN_SOC_RECEP: "Debe ingresar Razon Social del contribuyente receptor.",
                EFXP_DIR_RECEP: "Debe ingresar Direccion del contribuyente receptor.",
                EFXP_CMNA_RECEP: "Debe ingresar Comuna del contribuyente receptor.",
                EFXP_CIUDAD_RECEP: "Debe ingresar Ciudad del contribuyente receptor.",
                EFXP_GIRO_RECEP: "Debe ingresar Giro del contribuyente receptor.",
                EFXP_NMB_1: "Debe ingresar nombre o descripcion del primer item del detalle.",
                EFXP_QTY_1: "Cantidad de unidades del primer item del detalle debe ser mayor a 0.",
                EFXP_PRC_1: "Debe ingresar un valor."
            }

        });
    });
</script>
<script type="text/javascript">
    var rowCount = 1;
    function addMoreRows(frm) {
        $.ajax
        ({
            url: "NeoFacturaGLineaDetalle?lineaDetalle=" + (rowCount+1),
            success: function (html)
            {
                rowCount++;
                jQuery('#Detalle').append(html.detailLine);

                $('[name*="EFXP_NMB_"]').each(function () {
                    $(this).rules('add', {
                        required: true,
                        messages: {
                            required: "Debe ingresar nombre de producto."
                        }
                    });
                });
                $('[name*="EFXP_QTY_"]').each(function () {
                    $(this).rules('add', {
                        required: true,
                        number: true,
                        messages: {
                            required: "Cantidad de unidades del primer item del detalle debe ser mayor a 0."
                        }
                    });
                });
                $('[name*="EFXP_SUBT_"]').each(function () {
                    $(this).rules('add', {
                        required: true,
                        number: true,
                        messages: {
                            required: "El valor del subtotal debe ser mayor a 0."
                        }
                    });
                });
                $('[name*="EFXP_PRC_"]').each(function () {
                    $(this).rules('add', {
                        required: true,
                        number: true,
                        messages: {
                            required: "Debe ingresar el precio."
                        }
                    });
                });

                $('#EFXP_QTY_' + rowCount).change(function (e) { calculate(rowCount); });
                $('#EFXP_PRC_' + rowCount).change(function (e) { calculate(rowCount); });
                $('#ValorDR_' + rowCount).change(function (e) { calculate(rowCount); });

                $('#IMPUESTO_ADICIONAL_' + rowCount).change(function (e) { calculate(rowCount); });
                $('#EFXP_EXENTO_' + rowCount).change(function (e) { calculate(rowCount) });
                $('#TpoValor_' + rowCount).change(function (e) { calculate(rowCount) });
                $('#TpoMov_' + rowCount).change(function (e) { calculate(rowCount) });

                $('#Descuento_' + rowCount).change(function (e) { calculate(rowCount) });
            }
        });
    }

    function callEditDscRcg(lineaDetalle) {
        var linDetalle = lineaDetalle;
        $.ajax
            ({
                url: "DescuentoRecargoTempModal?lineaDetalle=" + linDetalle,
                success: function (html) {
                    $("#DescuentoRecargoBody").html("");
                    $("#DescuentoRecargoBody").html(html);
                    $("#ModalEditDescuentoRecargo").modal();
                }
            });
    }

    function removeLastRow() {
        jQuery('#Detalle' + rowCount).remove();
        rowCount--;
        if (rowCount <= 0) {
            rowCount = 1;
        }
        //$('#EFXP_SUBTOTAL').val(CalcularTotal());
        CalculateAllAgain();
    }

    function removeRow(removeNum) {
        jQuery('#Detalle' + removeNum).remove();
    }

    //----------------------


    function addMoreRef(frm) {
        refCount++;
        var recRow = '<div class="row form-group" id="Referencias' + refCount + '"> <div class="col-md-3">@*<select class="form-control" name="CodOperacion' + refCount + '" id="CodOperacion' + refCount + '" value=""> <option value="">Seleccionar</option> <option value="1">Anula documento de referencia</option> <option value="2">Corrige texto de documento de referencia</option> <option value="3">Corrige montos</option> </select>*@ </div> <div class="col-md-5"><input class="form-control" placeholder="Escriba el motivo" name="motivo' + refCount + '" id="motivo' + refCount + '" type="text" maxlength="90"> </div> <div class="col-md-3"><select class="form-control" name="TipoDocRef' + refCount + '" id="TipoDocRef' + refCount + '" value=""> <option value="">Seleccionar</option> <option value="30">Factura</option> <option value="32">Factura de venta bienes y servicios no afectos o exentos de IVA</option> <option value="35">Boleta</option> <option value="38">Boleta exenta</option> <option value="45">Factura de compra</option> <option value="55">Nota de débito</option> <option value="60">Nota de crédito</option> <option value="40">Liquidación Factura</option> <option value="43">Liquidación-Factura Electrónica</option> <option value="33">Factura Electrónica</option> <option value="34">Factura No Afecta o Exenta Electrónica</option> <option value="39">Boleta Electrónica</option> <option value="41">Boleta Exenta Electrónica</option> <option value="46">Factura de Compra Electrónica.</option> <option value="56">Nota de Débito Electrónica</option> <option value="61">Nota de Crédito Electrónica</option> <option value="50">Guía de Despacho.</option> <option value="52">Guía de Despacho Electrónica</option> <option value="103">Liquidación</option> <option value="110">Factura de Exportación Electrónica</option> <option value="111">Nota de Débito de Exportación Electrónica</option> <option value="112">Nota de Crédito de Exportación Electrónica</option> <option value="801">Orden de Compra</option> <option value="802">Nota de pedido</option> <option value="803">Contrato</option> <option value="804">Resolución</option> <option value="805">Proceso ChileCompra</option> <option value="806">Ficha ChileCompra</option> <option value="807">DUS</option> <option value="808">B/L (Conocimiento de embarque)</option> <option value="809">AWB (Air Will Bill)</option> <option value="810">MIC/DTA</option> <option value="811">Carta de Porte</option> <option value="812">Resolución del SNA donde califica Servicios de Exportación</option> <option value="813">Pasaporte</option> <option value="814">Certificado de Depósito Bolsa Prod. Chile.</option> <option value="815">Vale de Prenda Bolsa Prod. Chile</option> <option value="-4444">SET</option></select> </div> <div class="col-md-1"><input class="form-control" placeholder="" name="ref_folio' + refCount + '" id="ref_folio' + refCount + '" type="text"> </div> </div>';
        jQuery('#ReferenciasDetail').append(recRow);
    }

    function removeLastRef() {
        jQuery('#Referencias' + refCount).remove();
        refCount--;
        if (refCount <= 1) {
            refCount = 1;
        }
    }

    function removeRef(removeNum) {
        jQuery('#Referencias' + removeNum).remove();
    }

</script>
<script>
    $(document).ready(function () {
        $.datepicker.regional['es'] = {
            closeText: 'Cerrar',
            prevText: '<Ant',
            nextText: 'Sig>',
            currentText: 'Hoy',
            monthNames: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
            monthNamesShort: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'],
            dayNames: ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'],
            dayNamesShort: ['Dom', 'Lun', 'Mar', 'Mié', 'Juv', 'Vie', 'Sáb'],
            dayNamesMin: ['Do', 'Lu', 'Ma', 'Mi', 'Ju', 'Vi', 'Sá'],
            weekHeader: 'Sm',
            dateFormat: 'dd-mm-yy',
            firstDay: 1,
            isRTL: false,
            showMonthAfterYear: false,
            yearSuffix: ''
        };
        $.datepicker.setDefaults($.datepicker.regional['es']);
        $(function () {
            $("#FechaRecurrenteInicio").datepicker({ minDate: 0 });
            $("#FechaRecurrenteFinal").datepicker({ minDate: 0 });
        });
    });
</script>

<script type="text/javascript">

    $(document).ready(function () {
        $("#EFXP_RUT_RECEP").autocomplete({
            source: '@Url.Action("AutocompleteRutReceptor")',
            change: function (event, ui) { CSGetReceptorInfo($("#EFXP_RUT_RECEP").val()); }
        });
    });

    function CSGetReceptorInfo(value) {

        var url = '@Url.Action("GetReceptorByRUT")';

        $.getJSON(url, { RUT: $("#EFXP_RUT_RECEP").val() },
            function (data) {
                if (data.ok == true) {
                    $("#MakeNew").val(0);
                    $("#EFXP_RZN_SOC_RECEP").val(data.rzSocial);
                    $("#EFXP_DIR_RECEP").val(data.direccion);
                    $("#EFXP_CIUDAD_RECEP").val(data.ciudad);
                    $("#EFXP_GIRO_RECEP").val(data.giro);
                    $("#EFXP_CONTACTO").val(data.contacto);
                    $('#EFXP_CMNA_RECEP').val(data.comuna);
                    $('#email').val(data.emailCobranza);
                    $('#telefono').val(data.telefonoCobranza)
                }
                else {
                    $("#MakeNew").val(1);
                }

            }
            );
    }
    function CalculateAllAgain() {
        for (iw = 1; iw < rowCount + 1; iw++) {
            calculate(iw);
        }
    }

    $('#tipodoc').on('change', function () {

        var SELECTEDVALUE = this.value;
        if (SELECTEDVALUE == "") {
            $("#TIPO_DOC").text("[TIPO DOCUMENTO]");
            $("#NumeroDoc").text("XX");
            return;
        }

        else if (SELECTEDVALUE == 33) {
            $("#TIPO_DOC").text("FACTURA ELECTRÓNICA");
            var isDisabled = $("#EFXP_RUT_RECEP").is('[readonly]');
            if (isDisabled) {
                $("#EFXP_RUT_RECEP").attr("readonly", false);
            }
            $("#ExpTab").prop("disabled", true);
            $("#TabExp").css("display", "none");
            $("#TabGuia").css("display", "none");
            $("#GuiaTab").css("display", "none");
            $("#receptor").addClass("active in");
            $("#TabReceptor").addClass("active");
            $("#ExpTab").removeClass("active in");
            $("#IndicadorServicio").css("display", "none");

            $("#IsExentaIVA").val(0);
            $("#TitleNETO").text("Monto Neto");

            CalculateAllAgain();

        }
        else if (SELECTEDVALUE == 34) {
            $("#TIPO_DOC").text("FACTURA ELECTRÓNICA EXENTA");
            var isDisabled = $("#EFXP_RUT_RECEP").is('[readonly]');
            if (isDisabled) {
                $("#EFXP_RUT_RECEP").attr("readonly", false);
            }

            //iva
            GTotalIVA = 0;

            $("#IsExentaIVA").val(1);
            $("#TitleNETO").text("Monto Exento");

            //fin iva
            $("#ExpTab").prop("disabled", true);
            $("#TabExp").css("display", "none");
            $("#TabGuia").css("display", "none");
            $("#GuiaTab").css("display", "none");
            $("#receptor").addClass("active in");
            $("#TabReceptor").addClass("active");
            $("#ExpTab").removeClass("active in");
            $("#IndicadorServicio").css("display", "none");

            CalculateAllAgain();
        }
        else if (SELECTEDVALUE == 110) {
            $("#TIPO_DOC").text("FACTURA EXPORTACIÓN ELECTRÓNICA");
            $("#EFXP_RUT_RECEP").val("55555555-5");
            $("#EFXP_RUT_RECEP").attr("readonly", true);
            $("#ExpTab").prop("disabled", false);
            $("#TabExp").css("display", "block");
            $("#TabGuia").css("display", "none");
            $("#GuiaTab").css("display", "none");
            $("#receptor").addClass("active in");
            $("#IndicadorServicio").css("display", "none");

            GTotalIVA = 0;
            CalculateAllAgain();

        }
        else if (SELECTEDVALUE == 52) {
            $("#TIPO_DOC").text("GUIA DE DESPACHO");
            var isDisabled = $("#EFXP_RUT_RECEP").is('[readonly]');
            if (isDisabled)
                if (("#EFXP_RUT_RECEP").prop("readonly")) {
                    $("#EFXP_RUT_RECEP").attr("readonly", false);
                }
            $("#TabExp").css("display", "none");
            $("#GuiaTab").css("display", "block");
            $("#TabGuia").css("display", "block");
            $("#receptor").addClass("active in");
            $("#IndicadorServicio").css("display", "none");

            var GTotalIVA = GValorIVA * (subTotalNoExentos);//GmontoNeto;
            if (GTotalIVA < 0)
                GTotalIVA = 0;
            var ivatotal = GTotalIVA.toFixed();
            $('#EFXP_IVA').val(ivatotal);
            CalculateAllAgain();

        }
        else if (SELECTEDVALUE == 39) {
            $("#TIPO_DOC").text("BOLETA ELECTRÓNICA");
            var isDisabled = $("#EFXP_RUT_RECEP").is('[readonly]');
            if (isDisabled) {
                $("#EFXP_RUT_RECEP").attr("readonly", false);
            }
            $("#ExpTab").prop("disabled", true);
            $("#TabExp").css("display", "none");
            $("#TabGuia").css("display", "none");
            $("#GuiaTab").css("display", "none");
            $("#receptor").addClass("active in");
            $("#TabReceptor").addClass("active");
            $("#ExpTab").removeClass("active in");
            $("#IndicadorServicio").css("display", "block");
            for (var k = 1; k < rowCount + 1; k++) {
                $("#EFXP_EXENTO_" + k).prop("checked", false);
                $("#EFXP_EXENTO_" + k).prop("disabled", false);
                $("#IMPUESTO_ADICIONAL_" + k).val("[0,0]");
                $("#IMPUESTO_ADICIONAL_" + k).prop("disabled", true);

                CalculateAllAgain();
            }
        }
        else if (SELECTEDVALUE == 41) {
            $("#TIPO_DOC").text("BOLETA ELECTRÓNICA EXENTA");
            var isDisabled = $("#EFXP_RUT_RECEP").is('[readonly]');
            if (isDisabled) {
                $("#EFXP_RUT_RECEP").attr("readonly", false);
            }
            $("#ExpTab").prop("disabled", true);
            $("#TabExp").css("display", "none");
            $("#TabGuia").css("display", "none");
            $("#GuiaTab").css("display", "none");
            $("#receptor").addClass("active in");
            $("#TabReceptor").addClass("active");
            $("#ExpTab").removeClass("active in");
            $("#IndicadorServicio").css("display", "block");
            for (var k = 1; k < rowCount + 1; k++) {
                $("#EFXP_EXENTO_" + k).prop("checked", false);
                $("#EFXP_EXENTO_" + k).prop("disabled", true);
                $("#IMPUESTO_ADICIONAL_" + k).val("[0,0]");
                $("#IMPUESTO_ADICIONAL_" + k).prop("disabled", true);

                GTotalIVA = 0;
                CalculateAllAgain();
            }
        }
        
    });

    $('#REF_SI_NO').click(function () {
        if ($(this).is(':checked')) {
            $("#Referencias").show();
        } else {
            $("#Referencias").hide();
        }
    });



</script>

<style>
    .ui-dialog-titlebar {
        color: white;
    }

    .ui-draggable-handle {
        background: #ff4d4d;
    }

    .ui-dialog {
        position: fixed;
    }

    /*.ui-dialog-titlebar-close {

    }*/

    .nav-tabs {
        background-color: #fff;
    }

        .nav-tabs > li > a {
        }

        .nav-tabs > li.active > a, .nav-tabs > li.active > a:hover, .nav-tabs > li.active > a:focus {
            background-color: #0F879E;
            border: medium none;
            color: white;
        }

    #datosFact {
        border-style: solid;
        border-color: red;
        border-width: 1px;
    }

    #factura {
        background-color: white;
    }

    input::-webkit-outer-spin-button,
    input::-webkit-inner-spin-button {
        /* display: none; <- Crashes Chrome on hover */
        -webkit-appearance: none;
        margin: 0; /* <-- Apparently some margin are still there even though it's hidden */
    }

    .darkinput {
        color: #222f3f;
        background-color: #dde3ef;
    }

    .bigass {
        width: 100%;
        color: #222f3f;
        background-color: #dde3ef;
    }

    .midass {
        width: 80%;
    }

    .grayoutline {
        border: 1px solid #e6e6e6;
    }

    .botonesDetalle {
        background-color: #59ace0;
        color: #ecf5f9;
    }

    .btnEnviar {
        background-color: #495972;
        color: #c4cdd9;
    }

    .porcentaje {
        width: 10px;
    }

    input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }
</style>

